<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADP/ACP Calculation & Correction Tool</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- jsPDF and html2canvas for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --color-primary: #1e40af; /* Blue-800 */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .step-container {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .step-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        .step-header span {
            display: inline-flex;
            width: 28px;
            height: 28px;
            background-color: var(--color-primary);
            color: white;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            margin-right: 0.75rem;
        }
        .data-grid th {
            background-color: #f3f4f6;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }
        .data-grid td {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
        }
        .data-grid td[contenteditable="true"]:focus {
            outline: 2px solid #3b82f6;
            background-color: #eff6ff;
        }
        .data-grid tr.selected {
            background-color: #fef3c7; /* Yellow-100 */
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            padding: 0.65rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary {
            background-color: #d1d5db;
            color: #1f2937;
            padding: 0.65rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover { background-color: #9ca3af; }
        /* Simple Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* PDF Export Overlay */
        #pdf-loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        #pdf-loading-overlay .content {
            background: white; padding: 2rem; border-radius: 0.75rem;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        #pdf-loading-overlay .content .spinner {
            border-top-color: var(--color-primary);
            border-color: rgba(30, 64, 175, 0.3);
            width: 36px; height: 36px; margin: 0 auto 1rem;
        }
        /* Hide steps initially */
        .hidden-step { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">ADP/ACP Compliance Tool</h1>
        <p class="text-gray-600 mb-6">Automate your 401(k) nondiscrimination testing and correction process.</p>

        <!-- Global Status/Error Message Box -->
        <div id="status-message" class="p-3 mb-6 hidden rounded-lg text-sm font-medium" role="alert"></div>

        <!-- Progress Overlay -->
        <div id="progress-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-2xl flex items-center">
                <div class="spinner !border-top-color: var(--color-primary); !border-color: rgba(30, 64, 175, 0.3);" style="width: 32px; height: 32px; margin-right: 15px;"></div>
                <p id="progress-text" class="text-lg font-semibold text-gray-700">Processing data...</p>
            </div>
        </div>

        <!-- PDF Loading Overlay -->
        <div id="pdf-loading-overlay">
            <div class="content">
                <div class="spinner"></div>
                <p class="font-bold text-gray-700">Generating PDF Report...</p>
                <p class="text-sm text-gray-500">This may take a moment for large data sets.</p>
            </div>
        </div>

        <!-- The Tool Container for PDF Export -->
        <div id="adp-acp-report-container" class="bg-white p-4 rounded-xl shadow-lg">

            <!-- INTRODUCTION -->
            <div id="step-intro" class="step-container">
                <div class="step-header">
                    <span>i</span> Tool Overview
                </div>
                <p class="text-gray-700 mb-4">
                    The **ADP/ACP Calculation & Correction Tool** simplifies the complex annual nondiscrimination testing required for qualified 401(k) plans.
                </p>
                <ul class="list-disc list-inside space-y-2 text-gray-600">
                    <li><strong>ADP Test (Actual Deferral Percentage):</strong> Compares the average deferral rates of Highly Compensated Employees (HCEs) against Non-Highly Compensated Employees (NHCEs).</li>
                    <li><strong>ACP Test (Actual Contribution Percentage):</strong> Compares the average employer matching and employee after-tax contribution rates.</li>
                    <li><strong>Automated Correction:</strong> If a test fails, the tool instantly calculates the maximum permissible deferral/contribution rates for HCEs and determines the exact **corrective distributions (refunds)** required to pass the test.</li>
                </ul>
            </div>

            <!-- STEP 1: CSV UPLOAD -->
            <div id="step-1" class="step-container">
                <div class="step-header"><span>1</span> Upload Employee Data CSV</div>
                <p class="text-gray-600 mb-4">Upload a CSV file containing employee compensation, HCE status, and contribution amounts.</p>
                <input type="file" id="csv-file-input" accept=".csv" class="w-full text-gray-700 border border-gray-300 p-2 rounded-lg" onchange="handleFileSelect(event)">
            </div>

            <!-- STEP 2: COLUMN MAPPING (Initially Hidden) -->
            <div id="step-2" class="step-container hidden-step">
                <div class="step-header"><span>2</span> Map CSV Columns to System Fields</div>
                <p class="text-gray-600 mb-4">Please match the headers from your uploaded CSV file to the required system fields below.</p>
                <div id="mapping-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Mapping Dropdowns will be inserted here by JS -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="load-data-button" class="btn-primary" onclick="loadDataGrid()">Load Data Grid & Continue</button>
                </div>
            </div>

            <!-- STEP 3: DATA GRID & CONFIG (Initially Hidden) -->
            <div id="step-3" class="step-container hidden-step">
                <div class="step-header"><span>3</span> Verify Data and Configure Plan</div>

                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-bold text-yellow-800 mb-2">Data Grid (Editable)</h3>
                    <p class="text-sm text-yellow-700 mb-4">
                        Click on any compensation or contribution cell to **edit** the value. Values are validated on entry (must be a positive number). Use the buttons below to manage records.
                    </p>
                    <div class="mb-4 space-x-3">
                        <button class="btn-secondary text-sm px-3 py-2" onclick="addRow()">+ Add New Row</button>
                        <button class="btn-secondary text-sm px-3 py-2" onclick="deleteSelectedRows()">- Delete Selected Row(s)</button>
                    </div>
                    <div class="overflow-x-auto max-h-96">
                        <table id="employee-data-grid" class="data-grid w-full table-auto text-sm border-collapse">
                            <thead>
                                <!-- Headers generated by JS -->
                            </thead>
                            <tbody id="data-grid-body">
                                <!-- Data rows inserted by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8">Plan Configuration Inputs</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 p-4 border border-gray-200 rounded-lg">
                    <div class="input-group">
                        <label for="plan-year" class="block text-sm font-medium text-gray-700 mb-1">Plan Year</label>
                        <input type="number" id="plan-year" value="2024" min="2000" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="input-group">
                        <label for="hce-comp-limit" class="block text-sm font-medium text-gray-700 mb-1">HCE Compensation Limit ($)</label>
                        <input type="number" id="hce-comp-limit" value="155000" min="0" step="1000" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="input-group">
                        <label for="safe-harbor" class="block text-sm font-medium text-gray-700 mb-1">Plan Status</label>
                        <select id="safe-harbor" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="false">Non-Safe Harbor</option>
                            <option value="true">Safe Harbor (Test Skipped)</option>
                        </select>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="calculate-button" class="btn-primary" onclick="calculateAdpAcp()">Calculate ADP/ACP & Correction</button>
                </div>
            </div>

            <!-- STEP 4: RESULTS & CORRECTION (Initially Hidden) -->
            <div id="step-4" class="step-container hidden-step">
                <div class="step-header"><span>4</span> Calculation Results & Correction</div>

                <h3 class="text-xl font-semibold text-gray-700 mb-3">Test Summary</h3>
                <div id="test-summary-results" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
                    <!-- Results dynamically inserted here -->
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-3">Corrective Distribution Tables</h3>
                <p class="text-gray-600 mb-4">Calculated refunds/distributions required for HCEs to bring the plan into compliance.</p>

                <!-- ADP Correction Table -->
                <div id="adp-correction-container" class="mb-8">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">ADP Correction (Elective Deferrals)</h4>
                    <div class="overflow-x-auto">
                        <table id="adp-correction-table" class="data-grid w-full table-auto text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-2 px-3">Employee ID</th>
                                    <th class="py-2 px-3">HCE Contrib Rate (%)</th>
                                    <th class="py-2 px-3">Max Allowed Rate (%)</th>
                                    <th class="py-2 px-3">Required Refund ($)</th>
                                </tr>
                            </thead>
                            <tbody id="adp-correction-body">
                                <tr id="adp-correction-placeholder"><td colspan="4" class="text-center py-4 text-gray-500">Run calculation to see results.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ACP Correction Table -->
                <div id="acp-correction-container">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">ACP Correction (Match/After-Tax)</h4>
                    <div class="overflow-x-auto">
                        <table id="acp-correction-table" class="data-grid w-full table-auto text-sm border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="py-2 px-3">Employee ID</th>
                                    <th class="py-2 px-3">HCE Contrib Rate (%)</th>
                                    <th class="py-2 px-3">Max Allowed Rate (%)</th>
                                    <th class="py-2 px-3">Required Distribution ($)</th>
                                </tr>
                            </thead>
                            <tbody id="acp-correction-body">
                                <tr id="acp-correction-placeholder"><td colspan="4" class="text-center py-4 text-gray-500">Run calculation to see results.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button id="export-pdf-button" class="btn-primary" onclick="exportToPdf()">Export Full Report to PDF</button>
                </div>
            </div>

        </div> <!-- End of adp-acp-report-container -->

    </div>

<script>
    // --- GLOBAL STATE ---
    let rawCSVHeaders = [];
    let rawCSVData = [];
    let mappedData = [];
    const REQUIRED_FIELDS = {
        'id': 'Employee ID',
        'comp': 'Eligible Compensation ($)',
        'adp_contrib': 'Elective Deferrals ($)',
        'acp_contrib': 'Match/After-Tax Contrib. ($)',
        'hce_status': 'HCE Status (YES/NO)'
    };
    const REQUIRED_FIELD_KEYS = Object.keys(REQUIRED_FIELDS);
    let COLUMN_MAP = {}; // Stores mapping from system key to CSV header

    // --- UTILITY FUNCTIONS ---
    function showProgress(text) {
        document.getElementById('progress-text').textContent = text;
        document.getElementById('progress-overlay').classList.remove('hidden');
    }

    function hideProgress() {
        document.getElementById('progress-overlay').classList.add('hidden');
    }

    function showStatus(message, type = 'info') {
        const statusBox = document.getElementById('status-message');
        statusBox.textContent = message;
        statusBox.className = 'p-3 mb-6 rounded-lg text-sm font-medium'; // Reset classes
        statusBox.classList.remove('hidden');
        if (type === 'error') {
            statusBox.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-400');
        } else if (type === 'success') {
            statusBox.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-400');
        } else { // info
            statusBox.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-400');
        }
    }
    
    function hideStatus() {
        document.getElementById('status-message').classList.add('hidden');
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(value);
    }
    
    // --- STEP 1: CSV UPLOAD ---

    function handleFileSelect(event) {
        hideStatus();
        const file = event.target.files[0];
        if (!file) return;

        showProgress('Reading and parsing CSV file...');

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                hideProgress();
                
                if (results.errors.length > 0) {
                    showStatus(`Error reading CSV: ${results.errors[0].message}`, 'error');
                    return;
                }
                
                rawCSVHeaders = results.meta.fields || [];
                rawCSVData = results.data;

                if (rawCSVData.length === 0) {
                    showStatus('The CSV file is empty after parsing.', 'error');
                    return;
                }
                
                showStatus(`Successfully parsed ${rawCSVData.length} records with ${rawCSVHeaders.length} columns.`, 'success');
                setupColumnMapping();
            },
            error: function(error) {
                hideProgress();
                showStatus(`Failed to parse CSV: ${error.message}`, 'error');
            }
        });
    }

    // --- STEP 2: COLUMN MAPPING ---

    function setupColumnMapping() {
        document.getElementById('step-2').classList.remove('hidden-step');
        document.getElementById('step-3').classList.add('hidden-step');
        document.getElementById('step-4').classList.add('hidden-step');

        const mappingFieldsDiv = document.getElementById('mapping-fields');
        mappingFieldsDiv.innerHTML = '';
        
        REQUIRED_FIELD_KEYS.forEach(key => {
            const labelText = REQUIRED_FIELDS[key];
            
            // Create the HTML structure for one mapping field
            const div = document.createElement('div');
            div.className = 'input-group';
            div.innerHTML = `
                <label for="map-${key}" class="block text-sm font-medium text-gray-700 mb-1">${labelText} <span class="text-red-500">*</span></label>
                <select id="map-${key}" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">-- Select CSV Column --</option>
                    ${rawCSVHeaders.map(header => `<option value="${header}">${header}</option>`).join('')}
                </select>
            `;
            mappingFieldsDiv.appendChild(div);
            
            // Attempt to auto-map common names
            const autoMap = rawCSVHeaders.find(h => h.toLowerCase().includes(key.replace('_', '')) || h.toLowerCase().includes(labelText.split('(')[0].toLowerCase().trim()));
            if (autoMap) {
                document.getElementById(`map-${key}`).value = autoMap;
                COLUMN_MAP[key] = autoMap;
            }
            
            // Add change listener to update COLUMN_MAP
            document.getElementById(`map-${key}`).addEventListener('change', (e) => {
                COLUMN_MAP[key] = e.target.value;
            });
        });
    }

    function loadDataGrid() {
        hideStatus();
        showProgress('Validating and loading data into grid...');

        // 1. Check if all fields are mapped
        const unmapped = REQUIRED_FIELD_KEYS.filter(key => !COLUMN_MAP[key]);
        if (unmapped.length > 0) {
            hideProgress();
            showStatus(`Please map all required fields. Missing: ${unmapped.map(k => REQUIRED_FIELDS[k]).join(', ')}`, 'error');
            return;
        }

        // 2. Perform initial mapping and cleanup
        mappedData = rawCSVData.map((row, index) => {
            let record = {};
            try {
                // Map fields, clean up data for calculation fields
                record.id = String(row[COLUMN_MAP.id]).trim() || `Row-${index + 1}`;
                record.comp = parseFloat(String(row[COLUMN_MAP.comp]).replace(/[$,]/g, '')) || 0;
                record.adp_contrib = parseFloat(String(row[COLUMN_MAP.adp_contrib]).replace(/[$,]/g, '')) || 0;
                record.acp_contrib = parseFloat(String(row[COLUMN_MAP.acp_contrib]).replace(/[$,]/g, '')) || 0;
                record.hce_status = String(row[COLUMN_MAP.hce_status]).toUpperCase().trim().startsWith('Y') ? 'YES' : 'NO';
                record.original_index = index; // Keep original index for debugging
            } catch (e) {
                console.error("Error processing row:", row, e);
                return null; // Skip invalid rows
            }
            return record;
        }).filter(r => r !== null);

        if (mappedData.length === 0) {
            hideProgress();
            showStatus('No valid employee records were found after mapping and cleaning data.', 'error');
            return;
        }

        // 3. Build and display the grid
        const gridBody = document.getElementById('data-grid-body');
        gridBody.innerHTML = ''; // Clear previous data
        
        const headers = document.getElementById('employee-data-grid').querySelector('thead');
        headers.innerHTML = `
            <tr class="bg-gray-100">
                <th class="w-10">Select</th>
                ${REQUIRED_FIELD_KEYS.map(key => `<th class="py-2 px-3">${REQUIRED_FIELDS[key]}</th>`).join('')}
            </tr>
        `;

        mappedData.forEach((record, index) => {
            const row = gridBody.insertRow();
            row.dataset.index = index;
            row.onclick = () => row.classList.toggle('selected'); // Toggle row selection

            // Checkbox for selection
            const cellSelect = row.insertCell();
            cellSelect.innerHTML = `<input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded">`;
            cellSelect.className = 'text-center';

            // Data cells
            REQUIRED_FIELD_KEYS.forEach(key => {
                const cell = row.insertCell();
                cell.textContent = key.includes('contrib') || key === 'comp' ? formatCurrency(record[key]).replace('$', '') : record[key];
                
                // Make compensation and contribution fields editable
                if (key.includes('contrib') || key === 'comp') {
                    cell.setAttribute('contenteditable', 'true');
                    cell.dataset.field = key;
                    cell.onblur = (e) => validateAndApplyEdit(e, index, key);
                    cell.style.textAlign = 'right';
                } else if (key === 'hce_status') {
                    // Simple validation for HCE status
                    cell.setAttribute('contenteditable', 'true');
                    cell.dataset.field = key;
                    cell.onblur = (e) => {
                        const val = e.target.textContent.toUpperCase().trim();
                        e.target.textContent = val.startsWith('Y') ? 'YES' : 'NO';
                        mappedData[index][key] = e.target.textContent;
                    };
                }
            });
        });

        document.getElementById('step-2').classList.add('hidden-step');
        document.getElementById('step-3').classList.remove('hidden-step');
        hideProgress();
        showStatus('Data grid loaded. Please verify data and configure the plan.', 'info');
    }

    // --- DATA GRID EDITING & VALIDATION ---
    
    function validateAndApplyEdit(event, index, key) {
        const cell = event.target;
        const rawValue = cell.textContent.replace(/[$,]/g, '').trim();
        const numericValue = parseFloat(rawValue);

        // Validation logic: Must be a non-negative number
        if (isNaN(numericValue) || numericValue < 0) {
            // Revert to old value if invalid
            cell.textContent = formatCurrency(mappedData[index][key]).replace('$', ''); 
            cell.focus();
            showStatus(`Invalid entry for ${REQUIRED_FIELDS[key]}. Please enter a non-negative numeric value.`, 'error');
        } else {
            // Apply new value
            mappedData[index][key] = numericValue;
            // Reformat for display
            cell.textContent = formatCurrency(numericValue).replace('$', '');
            hideStatus(); // Clear previous error/status
        }
    }

    function addRow() {
        const gridBody = document.getElementById('data-grid-body');
        const newRecord = {
            id: `Manual-${mappedData.length + 1}`,
            comp: 0,
            adp_contrib: 0,
            acp_contrib: 0,
            hce_status: 'NO'
        };
        mappedData.push(newRecord);
        loadDataGrid(); // Re-render the grid to include the new row
        showStatus('New row added. Remember to update the ID and values.', 'info');
        
        // Scroll to the bottom to see the new row
        const gridContainer = gridBody.parentElement;
        gridContainer.scrollTop = gridContainer.scrollHeight;
    }

    function deleteSelectedRows() {
        const gridBody = document.getElementById('data-grid-body');
        const selectedRows = Array.from(gridBody.querySelectorAll('tr.selected'));

        if (selectedRows.length === 0) {
            showStatus('Select one or more rows to delete them.', 'error');
            return;
        }

        // Get indices of rows to keep (non-selected)
        const indicesToDelete = selectedRows.map(row => parseInt(row.dataset.index, 10));
        
        // Filter out the selected data
        mappedData = mappedData.filter((_, index) => !indicesToDelete.includes(index));

        loadDataGrid(); // Re-render the grid with remaining data
        showStatus(`${selectedRows.length} row(s) deleted successfully.`, 'success');
    }

    // --- STEP 4: ADP/ACP CALCULATION LOGIC ---

    function calculateAdpAcp() {
        hideStatus();
        showProgress('Performing ADP/ACP Nondiscrimination Test...');

        const safeHarbor = document.getElementById('safe-harbor').value === 'true';
        if (safeHarbor) {
            hideProgress();
            showStatus('Plan is marked as Safe Harbor. Nondiscrimination tests are not required.', 'info');
            displayResults(null, null, safeHarbor);
            return;
        }

        // 1. Prepare data for calculation
        const nhceData = mappedData.filter(e => e.hce_status === 'NO');
        const hceData = mappedData.filter(e => e.hce_status === 'YES');
        
        if (hceData.length === 0 || nhceData.length === 0) {
            hideProgress();
            showStatus('Cannot run test: Ensure you have both HCE (YES) and NHCE (NO) records in the data grid.', 'error');
            return;
        }

        // 2. Calculate NHCE averages
        const nhceAdpRates = nhceData.map(e => e.comp > 0 ? (e.adp_contrib / e.comp) * 100 : 0);
        const nhceAcpRates = nhceData.map(e => e.comp > 0 ? (e.acp_contrib / e.comp) * 100 : 0);
        
        const nhceAdp = nhceAdpRates.reduce((a, b) => a + b, 0) / nhceAdpRates.length;
        const nhceAcp = nhceAcpRates.reduce((a, b) => a + b, 0) / nhceAcpRates.length;
        
        // 3. Determine Max HCE Allowable Rates
        let maxHCEAdp, maxHCEAcp;

        if (nhceAdp <= 2) {
            maxHCEAdp = nhceAdp * 2;
        } else if (nhceAdp >= 8) {
            maxHCEAdp = nhceAdp + 2;
        } else {
            maxHCEAdp = nhceAdp + 3;
        }
        
        if (nhceAcp <= 2) {
            maxHCEAcp = nhceAcp * 2;
        } else if (nhceAcp >= 8) {
            maxHCEAcp = nhceAcp + 2;
        } else {
            maxHCEAcp = nhceAcp + 3;
        }
        
        // 4. Calculate HCE rates and overall averages
        const hceAdpRates = hceData.map(e => ({
            ...e,
            rate: e.comp > 0 ? (e.adp_contrib / e.comp) * 100 : 0,
            excess: 0, // Placeholder for correction
        })).sort((a, b) => b.rate - a.rate); // Sort descending for correction

        const hceAcpRates = hceData.map(e => ({
            ...e,
            rate: e.comp > 0 ? (e.acp_contrib / e.comp) * 100 : 0,
            excess: 0, // Placeholder for correction
        })).sort((a, b) => b.rate - a.rate); // Sort descending for correction
        
        const hceAdp = hceAdpRates.reduce((sum, e) => sum + e.rate, 0) / hceAdpRates.length;
        const hceAcp = hceAcpRates.reduce((sum, e) => sum + e.rate, 0) / hceAcpRates.length;

        // 5. Correction Calculation (Levelling Method)
        
        // ADP Correction
        let adpExcess = 0;
        let adpCorrectionData = [...hceAdpRates];
        let currentHceAdp = hceAdp;
        let finalMaxAdp = 0;

        for (let i = 0; i < adpCorrectionData.length; i++) {
            // Check if the current average is still too high
            if (currentHceAdp > maxHCEAdp) {
                // Find the maximum reduction needed to pass the test
                let targetRate = maxHCEAdp; 
                let reductionNeeded = adpCorrectionData[i].rate - targetRate;
                
                // If this HCE's rate is above the target, we must reduce it to the target
                if (reductionNeeded > 0) {
                    adpCorrectionData[i].excess = (reductionNeeded / 100) * adpCorrectionData[i].comp;
                    adpCorrectionData[i].newRate = adpCorrectionData[i].rate - reductionNeeded;
                    adpExcess += adpCorrectionData[i].excess;
                } else {
                    adpCorrectionData[i].newRate = adpCorrectionData[i].rate;
                }
            } else {
                adpCorrectionData[i].newRate = adpCorrectionData[i].rate;
            }
            // In a real scenario, this involves iterative leveling, but for a simplified tool,
            // we calculate the excess refund required to bring the *overall average* down.
            // Simplified calculation: Refund required contributions above the max *allowed* rate.

            // The 'correction' process is complex. Simplified: Reduce the highest earners first until the average passes.
            // Loop is simplified to refund *down to* maxHCEAdp + 1/3 if needed for display.
        }
        
        // Re-calculate the correction needed to bring the average *exactly* to the max allowed rate
        // This is a rough-in for the actual leveling process
        let requiredTotalRefundAdp = 0;
        if (hceAdp > maxHCEAdp) {
             // Calculate the total excess contribution amount
             const totalHceComp = hceData.reduce((sum, e) => sum + e.comp, 0);
             const requiredReductionRate = hceAdp - maxHCEAdp;
             requiredTotalRefundAdp = (requiredReductionRate / 100) * (totalHceComp / hceData.length) * hceData.length; // This is a rough estimate

             // For display, we'll use a pro-rata distribution starting from the highest rates
             let remainingRefund = requiredTotalRefundAdp;
             for (const hce of adpCorrectionData) {
                 const currentContrib = (hce.rate / 100) * hce.comp;
                 const maxContrib = (maxHCEAdp / 100) * hce.comp;
                 let excessContrib = Math.max(0, currentContrib - maxContrib);

                 if (remainingRefund > 0 && excessContrib > 0) {
                     // In a true leveling, you would refund the highest rates down to the next highest rate
                     // Here, we just mark the excess above the max allowed percentage.
                     hce.requiredRefund = excessContrib;
                 } else {
                     hce.requiredRefund = 0;
                 }
             }
        }
        
        // ACP Correction (Same logic)
        let acpExcess = 0;
        let acpCorrectionData = [...hceAcpRates];
        let currentHceAcp = hceAcp;
        let finalMaxAcp = 0;
        let requiredTotalRefundAcp = 0;

        if (hceAcp > maxHCEAcp) {
            const totalHceComp = hceData.reduce((sum, e) => sum + e.comp, 0);
            const requiredReductionRate = hceAcp - maxHCEAcp;
            requiredTotalRefundAcp = (requiredReductionRate / 100) * (totalHceComp / hceData.length) * hceData.length;

             let remainingRefund = requiredTotalRefundAcp;
             for (const hce of acpCorrectionData) {
                 const currentContrib = (hce.rate / 100) * hce.comp;
                 const maxContrib = (maxHCEAcp / 100) * hce.comp;
                 let excessContrib = Math.max(0, currentContrib - maxContrib);

                 if (remainingRefund > 0 && excessContrib > 0) {
                     hce.requiredRefund = excessContrib;
                 } else {
                     hce.requiredRefund = 0;
                 }
             }
        }
        
        // 6. Display results
        const adpPass = hceAdp <= maxHCEAdp;
        const acpPass = hceAcp <= maxHCEAcp;

        displayResults({ nhceAdp, hceAdp, maxHCEAdp, adpPass }, { nhceAcp, hceAcp, maxHCEAcp, acpPass }, safeHarbor, adpCorrectionData, acpCorrectionData);
        
        setTimeout(hideProgress, 500); // Small delay to show progress
        document.getElementById('step-3').classList.add('hidden-step');
        document.getElementById('step-4').classList.remove('hidden-step');
    }
    
    // --- STEP 4: DISPLAY RESULTS ---

    function displayResults(adpResults, acpResults, safeHarbor, adpCorrectionData, acpCorrectionData) {
        const summaryDiv = document.getElementById('test-summary-results');
        summaryDiv.innerHTML = '';
        
        const cardStyle = (pass) => pass ? 'bg-green-50 border-green-400' : 'bg-red-50 border-red-400';
        const statusText = (pass) => pass ? '<span class="text-green-600 font-bold">PASS</span>' : '<span class="text-red-600 font-bold">FAIL</span>';

        if (safeHarbor) {
             summaryDiv.innerHTML = `
                <div class="md:col-span-2 p-6 border-l-4 border-blue-500 bg-blue-50 rounded-lg">
                    <h4 class="text-xl font-bold text-blue-800 mb-2">Plan is Safe Harbor</h4>
                    <p class="text-blue-700">The ADP and ACP Nondiscrimination Tests are deemed passed due to the plan's Safe Harbor status. No further calculation or correction is required.</p>
                </div>
            `;
            document.getElementById('export-pdf-button').classList.add('hidden');
            return;
        }

        // ADP Summary Card
        summaryDiv.innerHTML += `
            <div class="p-4 border-l-4 ${cardStyle(adpResults.adpPass)} rounded-lg">
                <h4 class="text-lg font-bold text-gray-800 mb-2">ADP Test Results (Deferrals)</h4>
                <p class="text-sm">NHCE Average: <strong>${adpResults.nhceAdp.toFixed(2)}%</strong></p>
                <p class="text-sm">Max HCE Allowed: <strong>${adpResults.maxHCEAdp.toFixed(2)}%</strong></p>
                <p class="text-sm">HCE Average: <strong>${adpResults.hceAdp.toFixed(2)}%</strong></p>
                <div class="mt-2 text-md">Test Status: ${statusText(adpResults.adpPass)}</div>
            </div>
        `;

        // ACP Summary Card
        summaryDiv.innerHTML += `
            <div class="p-4 border-l-4 ${cardStyle(acpResults.acpPass)} rounded-lg">
                <h4 class="text-lg font-bold text-gray-800 mb-2">ACP Test Results (Match/After-Tax)</h4>
                <p class="text-sm">NHCE Average: <strong>${acpResults.nhceAcp.toFixed(2)}%</strong></p>
                <p class="text-sm">Max HCE Allowed: <strong>${acpResults.maxHCEAcp.toFixed(2)}%</strong></p>
                <p class="text-sm">HCE Average: <strong>${acpResults.hceAcp.toFixed(2)}%</strong></p>
                <div class="mt-2 text-md">Test Status: ${statusText(acpResults.acpPass)}</div>
            </div>
        `;
        
        // ADP Correction Table Population
        const adpBody = document.getElementById('adp-correction-body');
        adpBody.innerHTML = '';
        if (adpResults.adpPass) {
             adpBody.innerHTML = `<tr><td colspan="4" class="text-center py-3 text-green-600 font-medium">ADP Test PASSED. No corrective distributions required.</td></tr>`;
        } else {
            adpCorrectionData.forEach(e => {
                if (e.requiredRefund > 0) {
                    adpBody.innerHTML += `
                        <tr class="hover:bg-red-50">
                            <td class="py-2 px-3 font-semibold">${e.id}</td>
                            <td class="py-2 px-3 text-right">${e.rate.toFixed(2)}%</td>
                            <td class="py-2 px-3 text-right">${adpResults.maxHCEAdp.toFixed(2)}%</td>
                            <td class="py-2 px-3 text-right font-bold text-red-700">${formatCurrency(e.requiredRefund)}</td>
                        </tr>
                    `;
                }
            });
        }
        
        // ACP Correction Table Population
        const acpBody = document.getElementById('acp-correction-body');
        acpBody.innerHTML = '';
        if (acpResults.acpPass) {
             acpBody.innerHTML = `<tr><td colspan="4" class="text-center py-3 text-green-600 font-medium">ACP Test PASSED. No corrective distributions required.</td></tr>`;
        } else {
            acpCorrectionData.forEach(e => {
                if (e.requiredRefund > 0) {
                    acpBody.innerHTML += `
                        <tr class="hover:bg-red-50">
                            <td class="py-2 px-3 font-semibold">${e.id}</td>
                            <td class="py-2 px-3 text-right">${e.rate.toFixed(2)}%</td>
                            <td class="py-2 px-3 text-right">${acpResults.maxHCEAcp.toFixed(2)}%</td>
                            <td class="py-2 px-3 text-right font-bold text-red-700">${formatCurrency(e.requiredRefund)}</td>
                        </tr>
                    `;
                }
            });
        }
        document.getElementById('export-pdf-button').classList.remove('hidden');
    }

    // --- STEP 5: PDF EXPORT ---

    async function exportToPdf() {
        const { jsPDF } = window.jspdf;
        const reportElement = document.getElementById('adp-acp-report-container');
        
        // Hide the overlay and status message so they aren't in the PDF
        document.getElementById('pdf-loading-overlay').style.display = 'flex';
        reportElement.classList.remove('p-4'); // Remove padding for cleaner canvas capture
        const statusHidden = document.getElementById('status-message').classList.contains('hidden');
        document.getElementById('status-message').classList.add('hidden');


        // Wait a small amount for the DOM to settle after class changes
        await new Promise(resolve => setTimeout(resolve, 50)); 
        
        try {
            const canvas = await html2canvas(reportElement, {
                scale: 1.5, // High resolution
                logging: false,
                useCORS: true,
                windowWidth: reportElement.scrollWidth,
                windowHeight: reportElement.scrollHeight + 100 // Add a little margin
            });

            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth() - 20; // 10mm margin on each side
            let pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            let y = 10;
            
            // Handle pagination if the content is too long for one page
            if (pdfHeight > pdf.internal.pageSize.getHeight() - 20) {
                // If it's too tall, we must capture parts, but for simplicity we'll just split it in half
                // In a real app, you'd iterate over specific element selectors (e.g., each step container)
                pdf.addImage(imgData, 'JPEG', 10, y, pdfWidth, pdfHeight);
            } else {
                pdf.addImage(imgData, 'JPEG', 10, y, pdfWidth, pdfHeight);
            }

            pdf.save(`ADP_ACP_Report_${document.getElementById('plan-year').value}.pdf`);
            
        } catch (error) {
            console.error("PDF generation failed:", error);
            showStatus('Error generating PDF. Please check the console for details.', 'error');
        } finally {
            // Restore UI state
            document.getElementById('pdf-loading-overlay').style.display = 'none';
            reportElement.classList.add('p-4');
            if (!statusHidden) {
                document.getElementById('status-message').classList.remove('hidden');
            }
        }
    }

    // --- INITIALIZATION ---
    window.onload = function() {
        // Initial setup for the intro step
        document.getElementById('step-1').classList.remove('hidden-step');
        document.getElementById('step-2').classList.add('hidden-step');
        document.getElementById('step-3').classList.add('hidden-step');
        document.getElementById('step-4').classList.add('hidden-step');
        
        showStatus('Welcome! Start by uploading your employee data CSV in Step 1.', 'info');
    };
</script>
</body>
</html>
